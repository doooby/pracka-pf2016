//= require ./FontLoader
//= require ./Howler
//= require ./jquery.mobile.custom
//= require d2o
//= depend_on_asset pf

(function (factory) {

  var root = self;
  var PF = factory(root, {});
  root.PF = PF;

}(function (root, PF) {

  "use strict";
  var load_semaphore;

  <%= environment.find_asset('pf').to_s %>

  root.addEventListener("load", function() {
    (new FontLoader(["pracka_font"], {
      complete: function (err) {
        if (!err) {
          if (load_semaphore) load_semaphore();
          else load_semaphore = true;
        }
      }
    })).loadFonts();
  });

  (new D2O.Loader()).enqueueImages({
    "bg1": "<%= image_path 'pozadi1.png' %>",
    "bg2": "<%= image_path 'pozadi2.png' %>",

    "koci": "<%= image_path 'koci.png' %>",
    "tygr": "<%= image_path 'tygr.png' %>",
    "zela": "<%= image_path 'zela.png' %>",

    "brouk": "<%= image_path 'brouk.png' %>",
    "kluk": "<%= image_path 'kluk.png' %>",
    "oplatka": "<%= image_path 'oplatka.png' %>",
    "chobotnice": "<%= image_path 'chobotnice.png' %>",
    "brouk_tmavy": "<%= image_path 'brouk_tmavy.png' %>",
    "kluk_tmavy": "<%= image_path 'kluk_tmavy.png' %>",
    "oplatka_tmavy": "<%= image_path 'oplatka_tmavy.png' %>",
    "chobotnice_tmavy": "<%= image_path 'chobotnice_tmavy.png' %>",

    "mazlicek": "<%= image_path 'mazlicek.png' %>",
    "penize": "<%= image_path 'penize.png' %>",
    "srdce": "<%= image_path 'srdce.png' %>",
    "uspech": "<%= image_path 'uspech.png' %>",
    "zdravi": "<%= image_path 'zdravi.png' %>",
    "stesti": "<%= image_path 'stesti.png' %>",

    "vlevo": "<%= image_path 'vlevo.png' %>",
    "vlevo_on": "<%= image_path 'vlevo_on.png' %>",
    "vpravo": "<%= image_path 'vpravo.png' %>",
    "vpravo_on": "<%= image_path 'vpravo_on.png' %>"
  }).enqueue(function () {
    if (load_semaphore) this.doNext();
    else {
      var loader = this;
      load_semaphore = function () { loader.doNext(); };
    }
  }).enqueue(function () {
    PF.images = this.images;
    PF.canvas.prepare(90, 3/5);
    PF.canvas._on_resize();

    PF.scenes.createSceneHolder();

    if (root.location.search.substr(1) === "test_resume") {


      var test_scene = function () {
        PF.scene.clear();
        PF.scene.bg = "bg1";

        PF.gizmos.types.forEach(function (type, i) {
          var texture = PF.images[type], row_top = 4, tw2 = texture.width/ 2, th2 = texture.height/2;
          var s1, s2, b1, b2;

          s1 = new D2O.Sprite(texture);
          s1.position = new D2O.Vector2(tw2 + i*8, row_top + th2);
          b1 = new PF.utils.Button(i*8, row_top, texture.width, texture.height);
          b1.on_down = function () {
            var max = PF.player.getMaxStat();
            PF.player.stats[type] = PF.player.stats[max] + 1;
            test_scene();
          };

          row_top += 10;
          s2 = new D2O.Sprite(texture);
          s2.position = new D2O.Vector2(tw2 + i*8, row_top + th2);
          b2 = new PF.utils.Button(i*8, row_top, texture.width, texture.height);
          b2.on_down = function () {
            var min = PF.player.getMinStat();
            PF.player.stats[type] = PF.player.stats[min] - 1;
            test_scene();
          };


          PF.scene.add(s1);
          PF.scene.addButton(b1);
          PF.scene.add(s2);
          PF.scene.addButton(b2);

        });

        PF.player.addResumeStatus();
        PF.scene.singleFrame();
      };

      test_scene();
      return;
    }
    PF.scenes.intro();

  }).start();


  PF.audio = new Howl({
    urls: ["<%= audio_path 'gameplay.mp3' %>"],
    onload: function () {
      if (typeof PF.scenes.audio_loaded === "function") PF.scenes.audio_loaded();
      else PF.scenes.audio_loaded = true;
    },
    onplay: function () {
      if (typeof PF.scenes.audio_play === "function") PF.scenes.audio_play();
    }
  });


  return PF;
}));