//= require ./bliss
//= require d2o
//= depend_on_asset pf

(function (factory) {

  var root = self;
  var PF = factory(root, {});
  root.PF = PF;

}(function (root, PF) {

  "use strict";
  var load_semaphore;

  <%= environment.find_asset('pf').to_s %>

  document.addEventListener("DOMContentLoaded", function() {
    if (load_semaphore) load_semaphore();
    else load_semaphore = true;
  });

  (new D2O.Loader()).enqueueImages({
    "background": "<%= image_path 'pozadi.png' %>",

    "brouk": "<%= image_path 'brouk.png' %>",
    "kluk": "<%= image_path 'kluk.png' %>",
    "oplatka": "<%= image_path 'oplatka.png' %>",
    "chobotnice": "<%= image_path 'chobotnice.png' %>",

    "mazlicek": "<%= image_path 'mazlicek.png' %>",
    "penize": "<%= image_path 'penize.png' %>",
    "srdce": "<%= image_path 'srdce.png' %>",
    "uspech": "<%= image_path 'uspech.png' %>",
    "zdravi": "<%= image_path 'zdravi.png' %>",
    "stesti": "<%= image_path 'stesti.png' %>"
  }).enqueue(function () {
    if (load_semaphore) this.doNext();
    else load_semaphore = this.doNext;
  }).enqueue(function () {
    PF.images = this.images;
    PF.canvas.prepare(90, 3/5);
    PF.canvas.on_resize();

    PF.scene = new D2O.Scene(PF.canvas.buffer_ctx);
    PF.scene.singleFrame = function (since_last) {
      this._objects.forEach(function (o) { if (o.update) o.update(since_last); });
      PF.canvas.buffer_ctx.drawImage(PF.images["background"], 0, 0, PF.canvas.buffer.width, PF.canvas.buffer.height);
      this._objects.forEach(function (o) { if (o.render) o.render(PF.canvas.buffer_ctx); });
      PF.canvas.projectIntoTarget();
    };

    PF.scenes.gameplay();

  }).start();

  return PF;
}));